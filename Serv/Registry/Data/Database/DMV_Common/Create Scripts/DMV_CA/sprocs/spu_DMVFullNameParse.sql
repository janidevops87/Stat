if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[spu_DMVFullNameParse]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
Begin
	PRINT 'Dropping spu_DMVFullNameParse'
	drop procedure [dbo].[spu_DMVFullNameParse]
End
GO

	PRINT 'Creating spu_DMVFullNameParse'
GO


CREATE PROCEDURE spu_DMVFullNameParse AS
/******************************************************************************
**		File: spu_DMVFullNameParse.sql
**		Name: spu_DMVFullNameParse
**		Desc: Unique to CA this sp was based on MI’s process for cleaning and extracting full name
**			DMV data into FirstName, MiddleName, LastName and Suffix fields.
**
**             
**		Return values:
**
**		Called by:  
**             
**		Parameters:
**		Input							Output
**     ----------							-----------
**		None
**
**		Auth: christopher carroll
**		Date: 10/10/2007
*******************************************************************************
**		Change History
*******************************************************************************
**		Date:		Author:				Description:
**		--------	--------			--------------------------------------
**		10/10/2007  ccarroll			initial
**		12/18/2013	Moonray Schepart	revised Suffix creation logic
*******************************************************************************/

--- REMOVE QUOTES
	UPDATE DMVIMPORT_A
	SET FULLNAME = REPLACE(FULLNAME,'"', '')
	FROM DMVIMPORT_A 
	WHERE CHARINDEX(',', FULLNAME, 1) > 0

	-- REARRANGE NAME
	UPDATE DMVIMPORT_A
	SET FULLNAME =	SUBSTRING(FULLNAME,CHARINDEX(',', FULLNAME, 1)+1,LEN(FULLNAME)) + ' ' +
			SUBSTRING(FULLNAME,1,CHARINDEX(',', FULLNAME, 1)-1)
	FROM DMVIMPORT_A 
	WHERE CHARINDEX(',', FULLNAME, 1) > 0

--- END FIX GOT COMMA

-- START CONVERT TO UPPERCASE

	UPDATE DMVIMPORT_A
	SET FULLNAME = UPPER(FULLNAME)

-- END CONVERT TO UPPERCASE

--- START REMOVE COMMAS
	UPDATE DMVIMPORT_A
	SET FULLNAME = REPLACE(FULLNAME, ',', '')
	from DMVIMPORT_A 
	WHERE CHARINDEX(',',FULLNAME) > 0
--- END REMOVE COMMAS

--- START REMOVE PERIODS
	UPDATE DMVIMPORT_A
	SET FULLNAME = REPLACE(FULLNAME, '.', '')
	from DMVIMPORT_A 
	WHERE CHARINDEX('.',FULLNAME) > 0
--- END REMOVE PERIOD

--- START FIX TRAILING AND LEADING SPACES
	UPDATE DMVIMPORT_A
	SET FULLNAME = 	RTRIM(LTRIM(FULLNAME))
--- END FIX TRAILING AND LEADING SPACES

--- START REPLACE EMPTY WITH NULL
	UPDATE DMVIMPORT_A
	SET FULLNAME = NULL
	FROM DMVIMPORT_A
	WHERE LEN(FULLNAME) = 0
--- END  REPLACE EMPTY WITH NULL

--- START UPDATE SUFFIX WHERE SUFFIX IS FIRST SET OF CHARACTERS

	UPDATE DMVIMPORT_A
	SET SUFFIX = RTRIM(LTRIM(SUBSTRING(FULLNAME,1, CHARINDEX(' ', FULLNAME, 1) )))
	--  FULLNAME = RTRIM(LTRIM(REPLACE(FULLNAME, RTRIM(LTRIM(SUBSTRING(FULLNAME,1, CHARINDEX(' ', FULLNAME, 1) -1))), '')))
	FROM DMVIMPORT_A 
	WHERE (FULLNAME LIKE '[I][ IV][I ]%' 
	OR fullname like '[V][ ]%' 
	OR fullname like '[V][I][ ]%' 
	OR fullname like '[SJ][R][ ]%')
	AND LEN(RTRIM(LTRIM(SUBSTRING(FULLNAME,1, CHARINDEX(' ', FULLNAME, 1) )))) <= 3;

-- END UPDATE SUFFIX WHERE SUFFIX IS FIRST SET OF CHARACTERS

-- START UPDATE SUFFIX WHERE SUFFIX IS LAST SET OF CHARACTERS

	UPDATE DMVIMPORT_A
	SET SUFFIX = REVERSE(RTRIM(LTRIM(SUBSTRING(REVERSE(FULLNAME),1, CHARINDEX(' ', REVERSE(FULLNAME), 1) -1))))
 	--   FULLNAME = REVERSE(RTRIM(LTRIM(REPLACE(REVERSE(FULLNAME), RTRIM(LTRIM(SUBSTRING(REVERSE(FULLNAME),1, CHARINDEX(' ', REVERSE(FULLNAME), 1) -1))), ''))))

	FROM DMVIMPORT_A 
	WHERE  REVERSE(FULLNAME) LIKE '[ I][VI ][ I][^a-z]%' --    [I][ IV][I ]%' 
	OR REVERSE(FULLNAME) like '[V][I ]%' --'[V][ ]%' 
	OR REVERSE(FULLNAME) like '[V][I][ ]%' --'[V][ ]%' 
	OR REVERSE(FULLNAME) like '[I ][V][ ]%' --'[V][I][ ]%' 
	OR REVERSE(FULLNAME) like '[R][SJ][ ]%' -- '[SJ][R][ ]%'
-- END  UPDATE SUFFIX WHERE SUFFIX IS LAST SET OF CHARACTERS

--- START ADD FIRST AND LAST NAME
	UPDATE DMVIMPORT_A
	SET	LAST = RTRIM(LTRIM(SUBSTRING(FULLNAME,1, CHARINDEX(' ', FULLNAME, 1) -1))),
		FIRST  = RTRIM(LTRIM(SUBSTRING(FULLNAME, CHARINDEX(' ', FULLNAME, 1), LEN(FULLNAME))))
	from DMVIMPORT_A 
	WHERE FULLNAME IS NOT NULL
	AND CHARINDEX(' ', FULLNAME, 1) > 0
	AND CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1) = 0
	--AND ISNULL(FIRST, '') + ISNULL(LAST, '') + ISNULL(MIDDLE, '') = ''
	AND FIRST IS NULL 	AND LAST IS NULL	AND MIDDLE IS NULL
--- END ADD FIRST AND LAST NAME

--- START ADD FIRST , LAST AND MIDDLE NAME
	UPDATE DMVIMPORT_A
	SET	LAST = RTRIM(LTRIM(SUBSTRING(FULLNAME,1, CHARINDEX(' ', FULLNAME, 1) -1))),
		FIRST = RTRIM(LTRIM(SUBSTRING(FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1) - CHARINDEX(' ', FULLNAME, 1)))),
		MIDDLE = REPLACE(RTRIM(LTRIM(SUBSTRING(FULLNAME, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1), LEN(FULLNAME)))),'III','')
	from DMVIMPORT_A 
	WHERE FULLNAME IS NOT NULL
	AND CHARINDEX(' ', FULLNAME, 1) > 0
	AND CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1) > 0 
	AND CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1 )+1 ) = 0
	--AND ISNULL(FIRST, '') + ISNULL(LAST, '') + ISNULL(MIDDLE, '') = ''
	AND FIRST IS NULL 	AND LAST IS NULL	AND MIDDLE IS NULL
--- END ADD FIRST , LAST AND MIDDLE NAME

--- START REMOVE MULTIPLE SPACES BETWEEN NAMES
	UPDATE DMVIMPORT_A
	SET FULLNAME = REPLACE(FULLNAME, '  ', ' ')
	WHERE FULLNAME IS NOT NULL
	--AND ISNULL(FIRST, '') + ISNULL(LAST, '') + ISNULL(MIDDLE, '') = ''
	AND FIRST IS NULL 	AND LAST IS NULL	AND MIDDLE IS NULL
	AND FULLNAME LIKE '%  %'
--- START REMOVE MULTIPLE SPACES BETWEEN NAMES




--- START FIRST, MIDDLE, LAST AND SUFFIX FOR JR
	UPDATE DMVIMPORT_A
	SET	LAST = RTRIM(LTRIM(SUBSTRING(FULLNAME,1, CHARINDEX(' ', FULLNAME, 1) -1))),
		FIRST = RTRIM(LTRIM(SUBSTRING(FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1) - CHARINDEX(' ', FULLNAME, 1)))),
		MIDDLE = REPLACE(RTRIM(LTRIM(	SUBSTRING(FULLNAME, 		CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1)	, 		CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1 )+1 ) - CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1)	))),'III',''),
		SUFFIX = 	RTRIM(LTRIM(	SUBSTRING(FULLNAME, 		CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1 )+1 )	, LEN(FULLNAME)	)))
	from DMVIMPORT_A 
	WHERE FULLNAME IS NOT NULL
	AND CHARINDEX(' ', FULLNAME, 1) > 0
	AND CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1) > 0 
	AND CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1 )+1 ) > 0 
	AND CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1 )+1 )+1 ) = 0
	--AND ISNULL(FIRST, '') + ISNULL(LAST, '') + ISNULL(MIDDLE, '') = ''
	AND FIRST IS NULL 	AND LAST IS NULL	AND MIDDLE IS NULL
	AND FULLNAME LIKE '%[SJ1][R1]'

--- END FIRST, MIDDLE, LAST AND SUFFIX FOR JR, SR, II




--- START FIRST, MIDDLE, LAST AND SUFFIX FOR I, II, II, V, IV
	UPDATE DMVIMPORT_A
	SET	LAST  = RTRIM(LTRIM(SUBSTRING(FULLNAME,1, CHARINDEX(' ', FULLNAME, 1) -1))),
		FIRST = RTRIM(LTRIM(SUBSTRING(FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1) - CHARINDEX(' ', FULLNAME, 1)))),
		MIDDLE = REPLACE(RTRIM(LTRIM(SUBSTRING(FULLNAME, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1)	, 		CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1 )+1 ) - CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1)	))),'III',''),
		SUFFIX = 	RTRIM(LTRIM(	SUBSTRING(FULLNAME, 		CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1 )+1 )	, LEN(FULLNAME)	)))
	from DMVIMPORT_A 
	WHERE FULLNAME IS NOT NULL
	AND CHARINDEX(' ', FULLNAME, 1) > 0
	AND CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1) > 0 
	AND CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1 )+1 ) > 0 
	AND CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1 )+1 )+1 ) = 0
	--AND ISNULL(FIRST, '') + ISNULL(LAST, '') + ISNULL(MIDDLE, '') = ''
	AND FIRST IS NULL 	AND LAST IS NULL	AND MIDDLE IS NULL
	AND FULLNAME LIKE '%[^A-HJ-Z][I1V]' ----ccarroll 02/16/2007 CHANGED WAS '%[I1V]'
--- END FIRST, MIDDLE, LAST AND SUFFIX FOR JR
--- START FIRST, MIDDLE, LAST AND SUFFIX FOR SIR
	UPDATE DMVIMPORT_A
	SET	LAST  = RTRIM(LTRIM(SUBSTRING(FULLNAME,1, CHARINDEX(' ', FULLNAME, 1) -1))),
		FIRST = RTRIM(LTRIM(SUBSTRING(FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1) - CHARINDEX(' ', FULLNAME, 1)))),
		MIDDLE = RTRIM(LTRIM(	SUBSTRING(FULLNAME, 		CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1)	, 		CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1 )+1 ) - CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1)	))),
		SUFFIX = RTRIM(LTRIM(	SUBSTRING(FULLNAME, 		CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1 )+1 )	, LEN(FULLNAME)	)))
	from DMVIMPORT_A 
	WHERE FULLNAME IS NOT NULL
	AND CHARINDEX(' ', FULLNAME, 1) > 0
	AND CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1) > 0 
	AND CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1 )+1 ) > 0 
	AND CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1 )+1 )+1 ) = 0
	--AND ISNULL(FIRST, '') + ISNULL(LAST, '') + ISNULL(MIDDLE, '') = ''
	AND FIRST IS NULL 	AND LAST IS NULL	AND MIDDLE IS NULL
	AND FULLNAME LIKE '%SIR'
--- END FIRST, MIDDLE, LAST AND SUFFIX FOR JR


--- START ADD FIRST , LAST AND MIDDLE NAME FOR MORE THAN 2 SPACES
	UPDATE DMVIMPORT_A
	SET LAST = RTRIM(LTRIM(SUBSTRING(FULLNAME,1, CHARINDEX(' ', FULLNAME, 1) -1))),
	    FIRST = RTRIM(LTRIM(SUBSTRING(FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1) - CHARINDEX(' ', FULLNAME, 1)))),
	    MIDDLE = REPLACE(RTRIM(LTRIM(SUBSTRING(FULLNAME, CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1), LEN(FULLNAME)))),'III','')
	FROM DMVIMPORT_A 
	WHERE FULLNAME IS NOT NULL
	AND CHARINDEX(' ', FULLNAME, 1) > 0
	AND CHARINDEX(' ', FULLNAME, CHARINDEX(' ', FULLNAME, 1)+1) > 0 
	AND FIRST IS NULL 	AND LAST IS NULL	AND MIDDLE IS NULL
--- END ADD FIRST , LAST AND MIDDLE NAME


-- START Replace III with '' in MiddleName where suffix is present
-- UPDATE DMVIMPORT_A
-- SET MIDDLE = REPLACE(Middle,'III','')
-- WHERE Suffix Like '%[I1V]'
-- End Replace III with '' in MiddleName

--- START REPLACE EMPTY MiddleName WITH NULL
	UPDATE DMVIMPORT_A
	SET Middle = NULL
	FROM DMVIMPORT_A
	WHERE LEN(Middle) = 0
--	OR Middle = ''
--- END  REPLACE EMPTY WITH NULL

GO


